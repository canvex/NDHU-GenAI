{% extends "layouts/base.html" %}

{% block title %} Forms General {% endblock %} 

<!-- Element injected in the BODY element -->
{% block body_class %} sidebar-mini {% endblock body_class %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/static/assets/css/adminlte.min.css">

{% endblock stylesheets %}

<style>
  /* åŠ å…¥ loading å‹•ç•«æ¨£å¼ */
  /* åŠ å…¥ loading å‹•ç•«æ¨£å¼ */
  #loading {
    display: none;
    position: fixed; /* å›ºå®šä½ç½® */
    top: 50%; /* å‚ç›´å±…ä¸­ */
    left: 50%; /* æ°´å¹³å±…ä¸­ */
    transform: translate(-50%, -50%); /* ä½¿å…ƒç´ å±…ä¸­ */
    font-size: 20px;
    color: #007bff;
    z-index: 9999; /* ç¢ºä¿å®ƒåœ¨å…¶ä»–å…ƒç´ ä¸Šæ–¹ */
    background-color: rgba(255, 255, 255, 0.8); /* æ·ºè‰²èƒŒæ™¯ */
    border-radius: 10px; /* åŠ ä¸€äº›åœ“è§’ */
    padding: 20px; /* å…§é‚Šè·ï¼Œè®“å…§å®¹ä¸ç·Šè²¼é‚Šç·£ */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* æ·»åŠ é™°å½±æ•ˆæœ */
  }

  #loading .spinner {
    margin-right: 10px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
  }

  /* æ—‹è½‰å‹•ç•« */
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  body {
    display: flex;
  }

  .container {
    flex: 2;
    text-align: center;
  }

  .sidebar {
    width: 300px;
    padding: 10px;
    border-left: 1px solid #ccc;
  }

  canvas {
    border: 1px solid black;
    cursor: crosshair;
    max-width: 90%;
    /* display: block; */
    
  }

  ul {
    list-style-type: none;
    padding: 0;
  }


  li {
    padding: 5px;
    border-bottom: 1px solid #ccc;
    display: flex;
    justify-content: space-between;
  }
</style>

{% block content %}    

  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
{#            <h1>Upload Form</h1>#}
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item">Upload Form</li>
                <li class="breadcrumb-item active">select</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <!-- left column -->
           <div class="col-md-10">

          
           </div>

          <div class="col-md-10">
            <!-- general form elements -->
            <div class="card card-primary">
              <div class="card-header">
                <h3 class="card-title">è«‹é¸å–æ¨™ç±¤</h3>
              </div>
              <!-- /.card-header -->
              <!-- form start -->
              <form>
                <div class="card-body">
                 </div>
                  <div class="form-group">
                    <label for="fileInput">File input</label>
                    <div class="input-group">
                      <div class="custom-file">
                        <input type="file" class="custom-file-input" id="fileInput">
                        <label class="custom-file-label" for="fileInput">Choose file</label>
                      </div>
                      <div class="input-group-append">
                        <!-- <span class="input-group-text" >Upload</span> -->
                        <span class="input-group-text"  onclick="uploadImage()">Upload</span>

                        
                      </div>
                    </div>
                  </div>
                     

                        <!-- <input type="file" id="fileInput" accept="image/*" />
                        <button onclick="uploadImage()">ä¸Šå‚³</button>
                        <br /><br /> -->
                        <button onclick="exportData()">åŒ¯å‡º JSON</button>
                        <input
                          type="file"
                          id="importFile"
                          accept="application/json"
                          onchange="importData(event)"
                        />
                        <br /><br />
                        <!-- æ¨¡å¼åˆ‡æ›é–‹é—œå€åŸŸ -->
                        <div id="mode-switcher">
                          <label for="mode-toggle">æ¨¡å¼åˆ‡æ›ï¼š</label>
                          <input type="checkbox" id="mode-toggle" />
                          <span id="mode-status">ç›®å‰æ˜¯æ¨™é¡Œæ¨¡å¼</span>
                        </div>
                  
                        <div id="loading">
                          <div class="spinner"></div>
                          <span>è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</span>
                        </div>
                        <pre id="output"></pre>
                        <canvas id="canvas" ></canvas>
               
                    
                    <div class="input-group-append">
                      
                      <span class="input-group-text" onclick="uploadImage()" >Upload</span>
                    
                    </div>
                  
                
                <!-- /.card-body -->

                <div class="card-footer">
                  <a href="{{ url_for('home_blueprint.doc_fill') }}" class="btn btn-primary float-sm-right">
                    ç¢ºèª
                </a>

                </div>
              </form>
            </div>
            <!-- /.card -->

            <!-- Form Element sizes -->



            <!-- Input addon -->

          <!--/.col (right) -->
        </div>
        <!-- /.row -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <script>
    let isContentMode = false; // åˆå§‹ç‚ºæ¨™é¡Œæ¨¡å¼

    // å–å¾—é–‹é—œèˆ‡ç‹€æ…‹é¡¯ç¤ºå€åŸŸ
    const modeToggle = document.getElementById("mode-toggle");
    const modeStatus = document.getElementById("mode-status");

    // ç›£è½é–‹é—œæ”¹è®Šäº‹ä»¶
    modeToggle.addEventListener("change", () => {
      isContentMode = modeToggle.checked; // ç•¶é–‹é—œé–‹å•Ÿæ™‚æ˜¯å…§å®¹æ¨¡å¼ï¼Œå¦å‰‡æ˜¯æ¨™é¡Œæ¨¡å¼

      // æ›´æ–°é¡¯ç¤ºçš„æ¨¡å¼
      if (isContentMode) {
        modeStatus.textContent = "ç›®å‰æ˜¯å…§å®¹æ¨¡å¼";
      } else {
        modeStatus.textContent = "ç›®å‰æ˜¯æ¨™é¡Œæ¨¡å¼";
      }
    });

    const upload = document.getElementById("fileInput");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const titleList = document.getElementById("titleList");
    let img = new Image();
    let fields = [];
    let imgScale = 1;
    let selectedField = null;
    let isDragging = false;
    let isResizing = false;
    let dragOffsetX, dragOffsetY;
    let startX, startY;
    let resizeCorner = null; // æ–°å¢ä¸€å€‹è®Šæ•¸ä¾†å„²å­˜é¸æ“‡çš„ç¸®æ”¾è§’è½
    let isDrawing = false;

    upload.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    img.onload = function () {
      const maxWidth = window.innerWidth * 0.7;
      imgScale = maxWidth / img.width;
      canvas.width = img.width * imgScale;
      canvas.height = img.height * imgScale;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };

    // ç•¶æŒ‰ä¸‹æ»‘é¼ æ™‚
    canvas.addEventListener("mousedown", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / canvas.width;
      const y = (e.clientY - rect.top) / canvas.height;

      selectedField = fields.find(
        (f) =>
          x >= f.x && x <= f.x + f.width && y >= f.y && y <= f.y + f.height
      );

      if (selectedField) {
        // æª¢æŸ¥æ˜¯å¦é»æ“Šåˆ°å››å€‹è§’è½
        resizeCorner = getResizeCorner(x, y, selectedField);
        if (resizeCorner) {
          isResizing = true;
        } else {
          isDragging = true;
          dragOffsetX = x - selectedField.x;
          dragOffsetY = y - selectedField.y;
        }
        canvas.addEventListener("mousemove", onMouseMove);
      } else {
        // é–‹å§‹ç¹ªè£½æ–°çš„æ¡†é¸å€åŸŸ
        startX = x;
        startY = y;
        isDrawing = true;
      }
    });

    // ç•¶æ»‘é¼ ç§»å‹•æ™‚
    canvas.addEventListener("mousemove", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / canvas.width;
      const y = (e.clientY - rect.top) / canvas.height;

      // æª¢æŸ¥æ˜¯å¦æ»‘é¼ æ‡¸åœåœ¨æ¡†é¸å€åŸŸä¸Š
      const hoveredField = fields.find(
        (f) =>
          x >= f.x && x <= f.x + f.width && y >= f.y && y <= f.y + f.height
      );

      if (hoveredField) {
        canvas.style.cursor = "pointer"; // ç•¶æ»‘é¼ æ‡¸åœåœ¨æ¡†é¸å€åŸŸä¸Šï¼Œé¡¯ç¤ºå¯æ‹–æ›³æ¸¸æ¨™
      } else {
        canvas.style.cursor = "crosshair"; // å¦å‰‡ï¼Œæ¢å¾©é è¨­æ¸¸æ¨™
      }

      if (isDrawing) {
        redrawCanvas();
        ctx.strokeStyle = "blue";
        ctx.lineWidth = 2;
        ctx.strokeRect(
          startX * canvas.width,
          startY * canvas.height,
          (x - startX) * canvas.width,
          (y - startY) * canvas.height
        );
      } else if (isDragging && selectedField) {
        // æ‹–æ›³æ¡†é¸
        selectedField.x = x - dragOffsetX;
        selectedField.y = y - dragOffsetY;
        redrawCanvas();
      } else if (isResizing && selectedField && resizeCorner) {
        // æ ¹æ“šé¸æ“‡çš„è§’è½ä¾†èª¿æ•´å¤§å°
        switch (resizeCorner) {
          case "topLeft":
            // æ›´æ–°å·¦ä¸Šè§’å¤§å°ï¼Œä¸¦ç¢ºä¿å¯¬åº¦å’Œé«˜åº¦ç‚ºæ­£æ•¸
            selectedField.width += selectedField.x - x;
            selectedField.height += selectedField.y - y;
            selectedField.x = x;
            selectedField.y = y;
            // ç¢ºä¿å¯¬åº¦å’Œé«˜åº¦æ˜¯æ­£æ•¸
            if (selectedField.width < 0) {
              selectedField.x = x - selectedField.width;
              selectedField.width;
            }
            if (selectedField.height < 0) {
              selectedField.y = y + selectedField.height;
              selectedField.height = -selectedField.height;
            }
            break;
          case "topRight":
            // æ›´æ–°å³ä¸Šè§’å¤§å°
            selectedField.width = x - selectedField.x;
            selectedField.height += selectedField.y - y;
            selectedField.y = y;
            // ç¢ºä¿å¯¬åº¦å’Œé«˜åº¦æ˜¯æ­£æ•¸
            if (selectedField.width < 0) {
              selectedField.x = x + selectedField.width;
              selectedField.width = -selectedField.width;
            }
            if (selectedField.height < 0) {
              selectedField.y = y + selectedField.height;
              selectedField.height = -selectedField.height;
            }

            // åµæ¸¬æ˜¯å¦æœ‰åè½‰ï¼Œå¦‚æœæ˜¯ï¼Œå°±åˆ‡æ›ç‚ºå³ä¸‹è§’
            if (selectedField.height < 0) {
              resizeCorner = "bottomRight";
            }
            break;
          case "bottomLeft":
            // æ›´æ–°å·¦ä¸‹è§’å¤§å°
            selectedField.width += selectedField.x - x;
            selectedField.height = y - selectedField.y;
            selectedField.x = x;
            // ç¢ºä¿å¯¬åº¦å’Œé«˜åº¦æ˜¯æ­£æ•¸
            if (selectedField.width < 0) {
              selectedField.x = x + selectedField.width;
              selectedField.width = -selectedField.width;
            }
            if (selectedField.height < 0) {
              selectedField.y = y + selectedField.height;
              selectedField.height = -selectedField.height;
            }
            break;
          case "bottomRight":
            // æ›´æ–°å³ä¸‹è§’å¤§å°
            selectedField.width = x - selectedField.x;
            selectedField.height = y - selectedField.y;
            // ç¢ºä¿å¯¬åº¦å’Œé«˜åº¦æ˜¯æ­£æ•¸
            if (selectedField.width < 0) {
              selectedField.x = x + selectedField.width;
              selectedField.width = -selectedField.width;
            }
            if (selectedField.height < 0) {
              selectedField.y = y + selectedField.height;
              selectedField.height = -selectedField.height;
            }
            break;
        }

        // é‡æ–°ç¹ªè£½ç•«å¸ƒï¼Œæ›´æ–°æ¡†é¸å€åŸŸ
        redrawCanvas();
      }
      updateFieldList();
    });

    // ç•¶æ»‘é¼ æ”¾é–‹æ™‚
    canvas.addEventListener("mouseup", (e) => {
      if (isDrawing) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / canvas.width;
        const y = (e.clientY - rect.top) / canvas.height;

        let inputValue = "";

        // æ ¹æ“šæ¨¡å¼ä¾†æ±ºå®šé¡¯ç¤ºæ¨™é¡Œæˆ–å…§å®¹
        if (!isContentMode) {
          // æ¨™é¡Œæ¨¡å¼ï¼Œè®“ç”¨æˆ¶è¼¸å…¥æ¬„ä½åç¨±
          inputValue = prompt("è«‹è¼¸å…¥æ¨™é¡Œåç¨±ï¼š");
          mode = "title";
        } else {
          // å…§å®¹æ¨¡å¼ï¼Œè®“ç”¨æˆ¶è¼¸å…¥æ¬„ä½å…§å®¹
          inputValue = prompt("è«‹è¼¸å…¥dataå…§å®¹ï¼š");
          mode = "content";
        }

        // å¦‚æœæœ‰è¼¸å…¥ï¼Œå‰‡ä¿å­˜æ¡†é¸å€åŸŸä¸¦æ›´æ–°
        if (inputValue) {
          fields.push({
            mode: mode,
            name: inputValue, // æ ¹æ“šæ¨¡å¼ï¼Œè¼¸å…¥çš„æ˜¯æ¨™é¡Œæˆ–å…§å®¹
            x: Math.min(startX, x),
            y: Math.min(startY, y),
            width: Math.abs(x - startX),
            height: Math.abs(y - startY),
          });
          updateFieldList();
        }

        isDrawing = false;
      }

      // çµæŸæ‹–æ›³ã€èª¿æ•´å¤§å°çš„ç‹€æ…‹
      isDragging = false;
      isResizing = false;
      resizeCorner = null;
      selectedField = null;

      canvas.removeEventListener("mousemove", onMouseMove);
      redrawCanvas(); // é‡æ–°ç¹ªè£½ç•«å¸ƒï¼Œé¡¯ç¤ºæ›´æ–°å¾Œçš„æ¡†é¸å€åŸŸ
    });

    // æ ¹æ“šé¼ æ¨™é»æ“Šçš„ä½ç½®åˆ¤æ–·æ˜¯å¦é»æ“Šåˆ°è§’è½
    function getResizeCorner(x, y, field) {
      const cornerThreshold = 10; // é‚Šç•Œè·é›¢è‡¨ç•Œå€¼
      const left = field.x * canvas.width;
      const top = field.y * canvas.height;
      const right = (field.x + field.width) * canvas.width;
      const bottom = (field.y + field.height) * canvas.height;

      if (
        Math.abs(x * canvas.width - left) < cornerThreshold &&
        Math.abs(y * canvas.height - top) < cornerThreshold
      ) {
        return "topLeft";
      } else if (
        Math.abs(x * canvas.width - right) < cornerThreshold &&
        Math.abs(y * canvas.height - top) < cornerThreshold
      ) {
        return "topRight";
      } else if (
        Math.abs(x * canvas.width - left) < cornerThreshold &&
        Math.abs(y * canvas.height - bottom) < cornerThreshold
      ) {
        return "bottomLeft";
      } else if (
        Math.abs(x * canvas.width - right) < cornerThreshold &&
        Math.abs(y * canvas.height - bottom) < cornerThreshold
      ) {
        return "bottomRight";
      }
      return null;
    }

    function redrawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 2;

      fields.forEach((f) => {
        // æ ¹æ“š mode è¨­å®šä¸åŒé¡è‰²
        ctx.strokeStyle = f.mode === "title" ? "red" : "green"; // title = ç´…è‰²æ¡†, content = ç¶ è‰²æ¡†
        ctx.strokeRect(
          f.x * canvas.width,
          f.y * canvas.height,
          f.width * canvas.width,
          f.height * canvas.height
        );

        // é¡¯ç¤º Titleï¼ˆåœ¨æ¡†æ¡†ä¸Šæ–¹ï¼‰
        if (f.mode === "title") {
          ctx.fillStyle = "red";
          ctx.font = "bold 14px Arial";
          ctx.fillText(
            f.name,
            f.x * canvas.width,
            Math.max(f.y * canvas.height - 5, 14) // é¿å…æ–‡å­—è¶…å‡ºç•«å¸ƒ
          );
        }

        // é¡¯ç¤º Contentï¼ˆåœ¨æ¡†æ¡†å…§ï¼‰
        if (f.mode === "content") {
          ctx.fillStyle = "green";
          ctx.font = "22px Arial";
          ctx.fillText(
            f.name || "æœªå¡«å¯«å…§å®¹",
            f.x * canvas.width + 5, // ç¨å¾®å¾€å³ä¸€é»
            f.y * canvas.height + 30 // ç¨å¾®å¾€ä¸‹ï¼Œé¿å…å¤ªé é‚Š
          );
        }

        // ç•«å‡ºå››å€‹è§’è½çš„åœ“é»ï¼ˆæ–¹ä¾¿æ‹–æ›³ï¼‰
        const cornerSize = 5;
        ctx.fillStyle = "blue";
        const corners = [
          [f.x, f.y], // å·¦ä¸Š
          [f.x + f.width, f.y], // å³ä¸Š
          [f.x, f.y + f.height], // å·¦ä¸‹
          [f.x + f.width, f.y + f.height], // å³ä¸‹
        ];
        corners.forEach(([cx, cy]) => {
          ctx.beginPath();
          ctx.arc(
            cx * canvas.width,
            cy * canvas.height,
            cornerSize,
            0,
            Math.PI * 2
          );
          ctx.fill();
        });
      });
    }

    // æ›´æ–°æ¬„ä½åˆ—è¡¨
    function updateFieldList() {
      const contentList = document.getElementById("contentList");
      titleList.innerHTML = "";
      contentList.innerHTML = "";
      fields.forEach((f, index) => {
        let li = document.createElement("li");
        li.textContent = `${f.name} (x: ${f.x.toFixed(2)}, y: ${f.y.toFixed(
          2
        )})`;
        // ç·¨è¼¯åç¨±æŒ‰éˆ•
        let editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨è¼¯";
        editBtn.onclick = () => {
          let newName = prompt("è«‹è¼¸å…¥æ–°çš„åç¨±ï¼š", f.name);
          if (newName !== null && newName.trim() !== "") {
            fields[index].name = newName.trim();
            updateFieldList();
            redrawCanvas();
          }
        };

        // åˆªé™¤æŒ‰éˆ•
        let deleteBtn = document.createElement("button");
        deleteBtn.textContent = "åˆªé™¤";
        deleteBtn.onclick = () => {
          fields.splice(index, 1);
          updateFieldList();
          redrawCanvas();
        };
        li.appendChild(editBtn);
        li.appendChild(deleteBtn);
        // æ ¹æ“š mode é¡å‹ï¼ŒåŠ å…¥å°æ‡‰çš„æ¸…å–®
        if (f.mode === "title") {
          titleList.appendChild(li);
        } else if (f.mode === "content") {
          contentList.appendChild(li);
        }
      });
    }
    // åŒ¯å‡ºæ¡†é¸è³‡æ–™
    function exportData() {
      const absoluteFields = fields.map((f) => ({
        mode: f.mode, // ä¿®æ­£é€™è£¡ï¼Œç¢ºä¿æ¯å€‹æ¡†éƒ½æœ‰è‡ªå·±çš„æ¨¡å¼
        name: f.name,
        x: Math.round(f.x * img.width),
        y: Math.round(f.y * img.height),
        width: Math.round(f.width * img.width),
        height: Math.round(f.height * img.height),
      }));

      const dataStr =
        "data:text/json;charset=utf-8," +
        encodeURIComponent(JSON.stringify(absoluteFields, null, 2));
      const downloadAnchor = document.createElement("a");
      downloadAnchor.setAttribute("href", dataStr);
      downloadAnchor.setAttribute("download", "bounding_boxes.json");
      document.body.appendChild(downloadAnchor);
      downloadAnchor.click();
      downloadAnchor.remove();
    }

    // åŒ¯å…¥æ¡†é¸è³‡æ–™
    function importData(event) {
      const file = event.target.files[0];

      // ç¢ºä¿å³ä½¿é¸æ“‡ç›¸åŒçš„æª”æ¡ˆä¹Ÿæœƒè§¸ç™¼ change äº‹ä»¶
      event.target.value = "";

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedFields = JSON.parse(e.target.result);

            if (!img.complete) {
              img.onload = () =>
                updateFieldsWithRelativeCoordinates(importedFields);
            } else {
              updateFieldsWithRelativeCoordinates(importedFields);
            }
          } catch (error) {
            alert("ç„¡æ³•è§£æ JSON æª”æ¡ˆ");
          }
        };
        reader.readAsText(file);
      }
    }

    function updateFieldsWithRelativeCoordinates(importedFields) {
      fields = importedFields.map((f) => ({
        ...f,
        x: f.x / img.width,
        y: f.y / img.height,
        width: f.width / img.width,
        height: f.height / img.height,
      }));
      updateFieldList();
      redrawCanvas();
    }

    document
      .getElementById("importBtn")
      .addEventListener("change", importData, false);
    document
      .getElementById("exportBtn")
      .addEventListener("click", exportData, false);

    function uploadImage() {
      let fileInput = document.getElementById("fileInput").files[0];
      if (!fileInput) {
        alert("è«‹é¸æ“‡åœ–ç‰‡");
        return;
      }

      let formData = new FormData();
      formData.append("file", fileInput);

      // é¡¯ç¤º loading å‹•ç•«
      document.getElementById("loading").style.display = "flex"; // é¡¯ç¤º loading å‹•ç•«
      document.getElementById("output").textContent = ""; // æ¸…ç©ºä¹‹å‰çš„çµæœ

      fetch("/upload", {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          // éš±è— loading å‹•ç•«
          document.getElementById("loading").style.display = "none";

          // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
          if (data.error) {
            alert("éŒ¯èª¤: " + data.error); // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          } else {
            try {
              console.log("èª¿ç”¨ handleApiResponse ä¹‹å‰çš„è³‡æ–™:", data);
              handleApiResponse(data); // ğŸ”¹ å‘¼å«è™•ç†å‡½å¼
              // document.getElementById("output").textContent = JSON.stringify(
              //   data,
              //   null,
              //   2
              // ); // é¡¯ç¤º JSON çµæœ
            } catch (error) {
              console.error("è™•ç† API å›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤:", error); // ğŸ”´ è¨˜éŒ„éŒ¯èª¤
              alert("è™•ç†å›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ Console è¨Šæ¯ï¼");
            }
          }
        })
        .catch((error) => {
          console.error("éŒ¯èª¤:", error);
          // éš±è— loading å‹•ç•«
          document.getElementById("loading").style.display = "none";
          alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
        });
    }
    function handleApiResponse(data) {
      console.log("ğŸ”¹ API å›æ‡‰:", data);

      if (data.error) {
        alert("âŒ éŒ¯èª¤ï¼š" + data.error);
        return;
      }

      if (data.ocr_data && img.complete) {
        updateFieldsWithRelativeCoordinates(data.ocr_data);
      } else {
        img.onload = () => updateFieldsWithRelativeCoordinates(data.ocr_data);
      }
    }
  </script>
  

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <!-- jQuery -->
  <script src="/static/assets/plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="/static/assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- bs-custom-file-input -->
  <script src="/static/assets/plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>
  <!-- AdminLTE App -->
  <script src="/static/assets/js/adminlte.min.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="/static/assets/js/demo.js"></script>
  <script>
  $(function () {
    bsCustomFileInput.init();
  });
  </script>

{% endblock javascripts %}
